<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <%- include("../partials/_navbar.ejs") %>
    <h2>Hi, <%= user.username %>!</h2>
    <p>Your Current Level: <%= user.level %></p>
    <!-- Debug: Show Raw XP Value -->
    <p>DEBUG: XP = <%= user.xp %></p>
    <!-- XP Progress Bar -->
    <div class="xp-bar-container">
        <div class="xp-bar" id="xp-bar" style="width: <%= (user.xp % 100) %>%;"></div>
    </div>
    <p><%= user.xp % 100 %>/100 XP</p>
    <!-- Main Container for Two Sections -->
    <div class="dashboard-container">
        <!-- Left: Task List -->
        <div class="task-list">
            <h2>Your Tasks</h2>
            <form action="/tasks/add" method="POST">
                <input type="text" name="description" placeholder="Add a task" required>
                <button type="submit">Add Task</button>
            </form>
        
            <ul>
                <% tasks.forEach(task => { %>
                    <li class="task-item <%= task.completed ? 'completed' : '' %>">
                        <!-- Checkbox to mark complete -->
                        <form action="/tasks/toggle-complete/<%= task._id %>" method="POST">
                            <input type="checkbox" onchange="this.form.submit()" <%= task.completed ? 'checked' : '' %>>
                        </form>
                        
                        <!-- Task description -->
                        <span><%= task.description %> <small>(<%= task.mood %>)</small></span>
                        
                        <!-- Edit form (Hidden until triggered) -->
                        <form action="/tasks/edit/<%= task._id %>" method="POST" class="edit-form">
                            <input type="text" name="description" value="<%= task.description %>" required>
                            <button type="submit">Save</button>
                        </form>
        
                        <!-- Task action buttons -->
                        <button class="edit-btn">‚úèÔ∏è</button>
                        <form action="/tasks/delete/<%= task._id %>" method="POST" class="delete-form">
                            <button type="submit" class="delete-btn">üóëÔ∏è</button>
                        </form>
                    </li>
                <% }) %>
            </ul>
        </div>

        <!-- Right: Pet Section (Pet + Inventory) -->
        <div class="pet-section">
            <!-- Pet Environment -->
            <div class="pet-environment">
                <div class="pet-area">
                    <div id="pet-sprite" data-pet="<%= user.pet || 'default' %>"></div>
                </div>
            </div>

            <!-- Inventory Section -->
            <div class="inventory-container">
                <h2>Inventory</h2>
                <div id="inventory-items">
                    <% if (user.inventory && user.inventory.length > 0) { %>
                        <% user.inventory.forEach(item => { %>
                            <div class="inventory-item">
                                <img src="<%= item.image %>" alt="<%= item.name %>">
                                <p><%= item.name %></p>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <p>Your inventory is empty.</p>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
        <!-- Inject XP & Level Data for JavaScript -->
    <script>
        const userXP = <%= user.xp || 0 %>;
        const userLevel = <%= user.level || 1 %>;
    </script>
    <script src="/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.3.2"></script>
    <script src="/dashboard.js"></script>
</body>
</html>